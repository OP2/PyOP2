<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Parallel Execution Plan &#8212; PyOP2 2020.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css?v=def86cc0" />
    
    <script src="_static/documentation_options.js?v=63d4e452"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Mixed Types" href="mixed.html" />
    <link rel="prev" title="PyOP2 Linear Algebra Interface" href="linear_algebra.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mixed.html" title="Mixed Types"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="linear_algebra.html" title="PyOP2 Linear Algebra Interface"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PyOP2 2020.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Parallel Execution Plan</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="parallel-execution-plan">
<span id="plan"></span><h1>Parallel Execution Plan<a class="headerlink" href="#parallel-execution-plan" title="Link to this heading">¶</a></h1>
<p>For all PyOP2 backends with the exception of sequential, a parallel execution
plan is computed for each <code class="xref py py-func docutils literal notranslate"><span class="pre">par_loop()</span></code>. It contains information
guiding the code generator on how to partition, stage and colour the data for
efficient parallel processing.</p>
<section id="partitioning">
<span id="plan-partitioning"></span><h2>Partitioning<a class="headerlink" href="#partitioning" title="Link to this heading">¶</a></h2>
<p>The iteration set is split into a number of equally sized and contiguous
mini-partitions such that the working set of each mini-partition fits into
shared memory or last level cache. This is unrelated to the partitioning
required for MPI as described in <a class="reference internal" href="mpi.html#mpi"><span class="std std-ref">MPI</span></a>.</p>
</section>
<section id="local-renumbering-and-staging">
<span id="plan-renumbering"></span><h2>Local Renumbering and Staging<a class="headerlink" href="#local-renumbering-and-staging" title="Link to this heading">¶</a></h2>
<p>While a mini-partition is a contiguous chunk of the iteration set, the
indirectly accessed data it references is not necessarily contiguous. For each
mini-partition and unique <code class="xref py py-class docutils literal notranslate"><span class="pre">Dat</span></code>-<code class="xref py py-class docutils literal notranslate"><span class="pre">Map</span></code> pair, a
mapping from local indices within the partition to global indices is
constructed as the sorted array of unique <code class="xref py py-class docutils literal notranslate"><span class="pre">Map</span></code> indices accessed
by this partition. At the same time, a global-to-local mapping is constructed
as its inverse.</p>
<p>Data for indirectly accessed <code class="xref py py-class docutils literal notranslate"><span class="pre">Dat</span></code> arguments is staged in shared
device memory as described in <a class="reference internal" href="backends.html#backends"><span class="std std-ref">PyOP2 Backends</span></a>. For each partition, the
local-to-global mapping indicates where data to be staged in is read from and
the global-to-local mapping gives the location in shared memory data has been
staged at. The amount of shared memory required is computed from the size of
the local-to-global mapping.</p>
</section>
<section id="colouring">
<span id="plan-colouring"></span><h2>Colouring<a class="headerlink" href="#colouring" title="Link to this heading">¶</a></h2>
<p>A two-level colouring is used to avoid race conditions. Partitions are
coloured such that partitions of the same colour can be executed concurrently
and threads executing on a partition in parallel are coloured such that no two
threads indirectly reference the same data. Only <code class="xref py py-func docutils literal notranslate"><span class="pre">par_loop()</span></code>
arguments performing an indirect reduction or assembling a matrix require
colouring. Matrices are coloured per row.</p>
<p>For each element of a <code class="xref py py-class docutils literal notranslate"><span class="pre">Set</span></code> indirectly accessed in a
<code class="xref py py-func docutils literal notranslate"><span class="pre">par_loop()</span></code>, a bit vector is used to record which colours
indirectly reference it. To colour each thread within a partition, the
algorithm proceeds as follows:</p>
<ol class="arabic simple">
<li><p>Loop over all indirectly accessed arguments and collect the colours of all
<code class="xref py py-class docutils literal notranslate"><span class="pre">Set</span></code> elements referenced by the current thread in a bit mask.</p></li>
<li><p>Choose the next available colour as the colour of the current thread.</p></li>
<li><p>Loop over all <code class="xref py py-class docutils literal notranslate"><span class="pre">Set</span></code> elements indirectly accessed by the
current thread again and set the new colour in their colour mask.</p></li>
</ol>
<p>Since the bit mask is a 32-bit integer, up to 32 colours can be processed in a
single pass, which is sufficient for most applications. If not all threads can
be coloured with 32 distinct colours, the mask is reset and another pass is
made, where each newly allocated colour is offset by 32. Should another pass
be required, the offset is increased to 64 and so on until all threads are
coloured.</p>
<figure class="align-center" id="id1">
<img alt="_images/pyop2_colouring.svg" src="_images/pyop2_colouring.svg" />
<figcaption>
<p><span class="caption-text">Thread colouring within a mini-partition for a <code class="xref py py-class docutils literal notranslate"><span class="pre">Dat</span></code> on
vertices indirectly accessed in a computation over the edges. The edges are
coloured such that no two edges touch the same vertex within the partition.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The colouring of mini-partitions is done in the same way, except that all
<code class="xref py py-class docutils literal notranslate"><span class="pre">Set</span></code> elements indirectly accessed by the entire partition are
referenced, not only those accessed by a single thread.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Parallel Execution Plan</a><ul>
<li><a class="reference internal" href="#partitioning">Partitioning</a></li>
<li><a class="reference internal" href="#local-renumbering-and-staging">Local Renumbering and Staging</a></li>
<li><a class="reference internal" href="#colouring">Colouring</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="linear_algebra.html"
                          title="previous chapter">PyOP2 Linear Algebra Interface</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="mixed.html"
                          title="next chapter">Mixed Types</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/plan.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mixed.html" title="Mixed Types"
             >next</a> |</li>
        <li class="right" >
          <a href="linear_algebra.html" title="PyOP2 Linear Algebra Interface"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PyOP2 2020.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Parallel Execution Plan</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2012-2013, Imperial College et al.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    </div>
  </body>
</html>